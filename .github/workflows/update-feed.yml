name: Update PastPuzzle feed

on:
  schedule:
    - cron: "15 3 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-feed:
    runs-on: ubuntu-latest
    env:
      FEED_DAYS: "30"
      FEED_URL: "https://ping13.github.io/pastpuzzle-rss/feed.xml"
      TIMEZONE: "UTC"
      PODCAST_IMAGE_URL: "https://ping13.github.io/pastpuzzle-rss/cover.png"
      PASTPUZZLE_URL: "https://www.pastpuzzle.de/"
      PASTPUZZLE_JSON_URL: ${{ secrets.PASTPUZZLE_JSON_URL }}
      PASTPUZZLE_JSON_METHOD: "POST"
      PASTPUZZLE_JSON_BODY: "{\"timezoneoffset\":60,\"locale\":\"de\"}"
      PASTPUZZLE_HEADERS: '{"Content-Type":"application/json","Pragma":"no-cache","Accept":"*/*","Cache-Control":"no-cache","Origin":"https://www.pastpuzzle.de","Referer":"https://www.pastpuzzle.de/","Accept-Language":"de-DE,de;q=0.9","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.6 Safari/605.1.15","Sec-Fetch-Site":"cross-site","Sec-Fetch-Mode":"cors","Sec-Fetch-Dest":"empty","x-client-info":"supabase-js-web/2.57.4","content-profile":"public"}'
      PASTPUZZLE_API_KEY: ${{ secrets.PASTPUZZLE_API_KEY }}
      PASTPUZZLE_AUTHORIZATION: ${{ secrets.PASTPUZZLE_API_KEY }}
      PASTPUZZLE_RESOLVE_AUDIO: "1"
      PASTPUZZLE_AUDIO_REQUIRED: "0"
      PASTPUZZLE_DEBUG: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: uv sync --group test

      - name: Run tests
        run: uv run pytest

      - name: Debug env (lengths only)
        run: |
          echo "PASTPUZZLE_JSON_URL set: ${PASTPUZZLE_JSON_URL:+yes}"
          echo "PASTPUZZLE_API_KEY length: ${#PASTPUZZLE_API_KEY}"
          echo "PASTPUZZLE_AUTHORIZATION length: ${#PASTPUZZLE_AUTHORIZATION}"
          echo "PASTPUZZLE_HEADERS length: ${#PASTPUZZLE_HEADERS}"
          echo "PASTPUZZLE_API_KEY sha256: $(printf '%s' \"$PASTPUZZLE_API_KEY\" | sha256sum | cut -d' ' -f1)"
          echo "PASTPUZZLE_AUTHORIZATION sha256: $(printf '%s' \"$PASTPUZZLE_AUTHORIZATION\" | sha256sum | cut -d' ' -f1)"

      - name: Debug Supabase request (curl status only)
        run: |
          status=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST "$PASTPUZZLE_JSON_URL" \
            -H "Content-Type: application/json" \
            -H "Pragma: no-cache" \
            -H "Accept: */*" \
            -H "Cache-Control: no-cache" \
            -H "Origin: https://www.pastpuzzle.de" \
            -H "Referer: https://www.pastpuzzle.de/" \
            -H "x-client-info: supabase-js-web/2.57.4" \
            -H "content-profile: public" \
            -H "apikey: $PASTPUZZLE_API_KEY" \
            -H "authorization: Bearer $PASTPUZZLE_AUTHORIZATION" \
            --data-raw "$PASTPUZZLE_JSON_BODY")
          echo "Supabase status: $status"

      - name: Update feed
        run: uv run python -m src.main

      - name: Commit changes
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/archive.json docs/feed.xml
          git commit -m "Update PastPuzzle feed"
          git push
